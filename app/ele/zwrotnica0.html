<!DOCTYPE html>
<html lang="pl">
<head>
   <meta charset="UTF-8" />
   <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
   <meta http-equiv="x-ua-compatible" content="ie=edge" />
   <title>Filtr-0</title>  
   <meta name="HandheldFriendly" content="true">
   <meta name="mobile-web-app-capable" content="yes"> 
   <meta name="theme-color" content="#008">
   <link rel="shortcut icon" type="image/svg+xml" size="any" href="../../img/dom.svg"> 
   <link rel="manifest" href="../../zorro.web.json"> 
   <link rel="stylesheet" href="../../css/style.css" />
   <link rel="stylesheet" href="../../css/all.css" />
   <style>
    .b {font-weight:bold;} 
    .line {margin:0.2em 0;max-width: 45%;}
    .em3,.em4,.em5,.em6 {display: inline-block;}
    .em3 {width: 3em;}
    .em4 {width: 4em;}
    .em5 {width: 5em;}
    .em6 {width: 6em;}
    img.filter {width:12em;}
    div.pass {border-bottom:1px solid gray;}
    div.col2 {
        width: 50%;
        display: grid;
        float: left;
        padding: 1%;
    }
    .left {float:left;}
    .right {float:right;}

    @media (max-width: 960px) {
    div.col2 {
        width: 100%;  
    }
    img.filter {
        float: right;
        width: 8em;
    }
}   
</style>
        <script src="https://code.highcharts.com/highcharts.js"></script>
        <script src="https://code.highcharts.com/modules/series-label.js"></script>
        <script src="https://code.highcharts.com/modules/exporting.js"></script>
        <script src="https://code.highcharts.com/modules/export-data.js"></script>
        <script src="https://code.highcharts.com/modules/accessibility.js"></script> 
        <script src="./js/wykresy.js"></script> 
</head>


<script>

let dane = {
    "bass":[],
    "middle":[],
    "treble":[],
    "suma":[],
    "line":[],
}

let category = [];
for (i=1;i<101;i++){
    let f = Math.exp(i/10) * 10;
    if (f<20) continue;
    if (f>25000) break;
    //console.log(i,f)
    category.push(Math.round(f));
    dane.line.push(-6);
}


const filterBassVal=(f,RG,L1,C1,RL1,R1,C2,R2,test)=>{
    let inductor1 =  (2*Math.PI*f*L1) ;    
    let capacitor1 = 1/(2*Math.PI*f*C1);
    let capacitor2 = 1/(2*Math.PI*f*C2);
    //console.log(f,"i1="+inductor1, "c1="+capacitor1, "c2="+capacitor2)
    let L1RL1        = inductor1 +RL1;
    let chain01       = (L1RL1 * R1)/(L1RL1 + R1);
    //console.log(f,chain01);
    let chain1       = (chain01 * capacitor1)/(chain01 + capacitor1);
    let chain2       = capacitor2 + R2;
    let chainSpeaker = (chain2*RG)/(chain2+RG)
    //console.log(f,"ch1="+chain1, "ch2="+chain2, "chaS="+chainSpeaker)
    gain = chainSpeaker/(chainSpeaker + chain1);
    return gain;
}   

const calcBass=()=>{
    dane.bass.length = 0;
    let L1 = parseFloat(document.getElementById("coil1").value);
    let RL1= parseFloat(document.getElementById("resistorl1r").value);
    let R1 = parseFloat(document.getElementById("resistorl1s").value);
    let C1 = parseFloat(document.getElementById("capacitor1").value); 
    let C2 = parseFloat(document.getElementById("capacitor2").value);
    let R2 = parseFloat(document.getElementById("resistor2").value);
    let RG = parseFloat(document.getElementById("resistorg").value);
    let test = false;//document.getElementById("test1").checked ?? false;
    //console.log("Bass L1="+L1,"C1="+C1,"R1S="+RL1,"R1R="+R1,"R2="+R2,"RG="+RG,"C2="+C2,"test=",test);
    L1 = L1/1000;
    C1 = C1/1000000;
    C2 = C2/1000000;
    
    let frq = 1/(2 * Math.PI * Math.sqrt(L1 * C2));
    let frqi = Math.round(frq);
    document.getElementById("frq1").value = frqi;

	let skala = 1;
	category.forEach((f)=>{
		let gain=filterBassVal(f,RG,L1,C1,RL1,R1,C2,R2,test);
        let dB = 10*Math.log(gain/skala);
        dB = Math.round(dB*100)/100;
        //dane.bass.push([f,dB]);
        dane.bass.push(dB);
    });
} 

const calcZwrotnica2a=()=>{
    console.log("change");
}
const calcZwrotnica2=()=>{
    calcBass();    
    if (wykres) updateWykres(dane); else rysujWykres("highchart",category,dane);    
    //console.log(wykres)
    wykres.yAxis[0].setExtremes(-20,0);
}

//---dom ready--------------------------------
document.addEventListener("DOMContentLoaded",function(){
    calcZwrotnica2();
})
//---DOM READY----------------------------------

function logslider(position) {
    let val = (position*position/200)/10
    val = Math.round(val*100)/100
    if (val<0.01) val = 0.001;
    return val;
}

const slides=(ten)=>{
    let id = ten.dataset.id;
    let position = parseInt(ten.value);
    let prefix = id.substr(0, 3);
    if (prefix ==="coi" && position == 200) position*=10;
    if (prefix ==="res" && position == 200) position*=10;
    if (prefix ==="cap" && position == 500) position*=10;
    let val = logslider(position);
    //console.log(prefix, "id="+id,"pos=["+position+"] val"+val);
    document.getElementById(id).value=val;
    calcZwrotnica2();
}

</script>
<body>
    <div class="wrapper">

        <app-menu title="Filtr0" name="ZnakZorro" link="../../"></app-menu><script src="../../appMenu.js"></script>  

        <div class="col2 right">

        <div class="container">
            <figure class="highcharts-figure">
                <div id="highchart"></div>
                <p class="highcharts-description"></p>
            </figure>
        </div>
        

    </div>

    <div class="col2 left">
        <!--div class="line"><span class="em3 b"></span>      <button class="btn em6"           onClick="calcZwrotnica2()">Calc</button></div-->
        <div class="container pass"> 
            <div style="float:right;"">
                <img src="./img/LCR-zwrot-0.svg" class="filter" /><br />
                <button class="btn em6"           onClick="calcZwrotnica2()">Calc</button>
            </div>
            <h3>Bass
                <!--input id="test1" type="checkbox">test-->
            </h3>             
            <div class="line">
                <span class="em3 b">L1:</span>
                <span><input class="em4" id="coil1"     oninput="calcZwrotnica2a()" value="0.8"> mH</span>
                <span><input type="range" data-id="coil1" onchange="slides(this)" value="40" min="0" max="200" step="1"></span>
            </div>
            <div class="line">
                <span class="em3 b">RL1:</span>
                <span><input class="em4" id="resistorl1r"     oninput="calcZwrotnica2a()" value="4"> E</span>
                <span><input type="range" data-id="resistorl1r" onchange="slides(this)" value="90" min="0" max="200" step="1"></span>
            </div>
            <div class="line">
                <span class="em3 b">R1:</span>
                <span><input class="em4" id="resistorl1s"     oninput="calcZwrotnica2a()" value="3.2"> E</span>
                <span><input type="range" data-id="resistorl1s" onchange="slides(this)" value="80" min="0" max="200" step="1"></span>
            </div>
            <div class="line">
                <span class="em3 b">C1:</span>
                <span><input class="em4" id="capacitor1"     oninput="calcZwrotnica2a()" value="3.3"> uF</span>
                <span><input type="range" data-id="capacitor1" onchange="slides(this)" value="82" min="0" max="500" step="1"></span>
            </div>
            <div class="line">
                <span class="em3 b">C2:</span>
                <span><input class="em4" id="capacitor2"     oninput="calcZwrotnica2a()" value="33"> uF</span>
                <span><input type="range" data-id="capacitor2" onchange="slides(this)" value="257" min="0" max="500" step="1"></span>
            </div>
            <div class="line">
                <span class="em3 b">R2:</span>
                <span><input class="em4" id="resistor2"     oninput="calcZwrotnica2a()" value="4"> E</span>
                <span><input type="range" data-id="resistor2" onchange="slides(this)" value="90" min="0" max="200" step="1"></span>
            </div>
            <div class="line"><span class="em3 b">RG:</span>    <input class="em4" id="resistorg" onchange="calcZwrotnica2a()" value="4"> Om</div>
            <div class="line"><span class="em3 b">FRQ:</span>  <input class="em4 b" id="frq1"> Hz</div>
        </div>

        

        <div class="klawisze">
            <button class="btn red"           onClick="defaulty()">Default</button>
            <button class="btn blue"           onClick="zapisz()">Zapisz</button>
            <button class="btn green"           onClick="odczyt()">Odczyt</button>
            <button class="btn em6"           onClick="calcZwrotnica2()">Calc</button>
        </div>

    </div>
        
    </div>

    
<script>

const zapisz=()=>{
    let alles = document.querySelectorAll("input");
    let zapis ={}
    alles.forEach((a)=>{
        if (a.id && a.value) {
            console.log(a)
            zapis[a.id]=a.value
        }
    })
    console.log(zapis)
}
const odczyt=()=>{

}
const defaulty=()=>{

}
 


</script>

</body>
</html>
